/*
	Fuzzy controler to control the agent's steerijng behavior
	creation: 01-aoct-2021 pierre.chevaillier@enib.fr inception
	comment: under development incomplete and not stable
*/

FUNCTION_BLOCK stateEstimator

// Define input variable
VAR_INPUT
	distance : REAL;
	direction : REAL;
  linearVelocity : REAL;
  angularVelocity : REAL;
END_VAR

// Define output variable
VAR_OUTPUT
	mood : REAL;
END_VAR

// Fuzzify input variables 'distance' and 'direction':
FUZZIFY distance
	TERM near := (0, 1) (2, 0);
	TERM far := (0, 0) (2, 1);
END_FUZZIFY

FUZZIFY direction
	TERM backLeft := (-3.15, 1) (-2.356, 1) (-1.57, 0);
  TERM onTheLeft := (-2.356, 0) (-1.57, 1) (-0.785, 1) (0, 0);
	TERM ahead := (-0.785, 0) (0, 1) (0.785, 0);
  TERM onTheRight := (0, 0) (0.785, 1) (1.57, 1) (2.356, 0);
  TERM backRight := (1.57, 0) (2.356, 1) (3.15, 1);
END_FUZZIFY

FUZZIFY linearVelocity
  TERM verySlow := (-1, 0) (0, 1) (1, 0);
  TERM slow := (0, 0) (0.1, 1) (0.2, 0);
  TERM fast := (0.7, 0) (0.8, 1) (0.9, 0);
  TERM veryFast := (0.8, 0) (0.9, 1) (1.0, 0);
END_FUZZIFY

// Defuzzify output variables
DEFUZZIFY mood
	TERM veryAngry := (-1, 0) (0, 1) (1, 0);
	TERM angry := (0, 0) (0.1, 1) (0.2, 0);
	TERM neutral := (0.7, 0) (0.8, 1) (0.9, 0);
  TERM cool := (0.8, 0) (0.9, 1) (1.0, 0);
	METHOD : COG; // Use 'Center Of Gravity' defuzzification method
	DEFAULT := 10.0;	// Default value used if no rule activates defuzzifier
END_DEFUZZIFY

// Inference rules
RULEBLOCK No1
	AND : MIN;
	ACT : PROD;	// Use 'min' activation method (implication: Larsen,  Mandani ...)
	ACCU : MAX;	// Use 'max' accumulation method ("and_also")

	RULE R1 : IF distance IS near THEN mood IS angry;
  RULE R2 : IF distance IS far THEN mood IS neutral;
END_RULEBLOCK

END_FUNCTION_BLOCK
